# Тестирование функции открытия игры

## Обзор

Данный документ описывает тестовое покрытие для функции открытия игры. Функция открытия игры отвечает за аутентификацию пользователя в выбранной игре и установку соответствующих сессионных переменных.

## Архитектура функции открытия игры

Функция открытия игры реализована в `index.php` и состоит из следующих шагов:

1. **Получение параметров**: Извлечение `gid` (ID игры) и `uid` (ID пользователя) из POST запроса
2. **Валидация игры**: Проверка существования игры с указанным ID
3. **Валидация пользователя**: Проверка существования пользователя и его принадлежности к игре
4. **Установка сессии**: Сохранение `game_id` и `user_id` в сессии
5. **Перенаправление**: Переход на страницу игры (map)

## Структура тестов

### Unit тесты (`tests/unit/OpenGameTest.php`)

Модульные тесты проверяют отдельные аспекты функции открытия игры:

#### 1. Успешные сценарии открытия (тесты 1.x)

- **testSuccessfulGameOpening**: Базовое успешное открытие игры
- **testOpenGameWithMultiplePlayers**: Открытие игры с несколькими игроками
- **testOpenGameWithDifferentTurnTypes**: Открытие игр с разными типами ходов

#### 2. Обработка ошибок (тесты 2.x)

- **testOpenNonExistentGame**: Попытка открыть несуществующую игру
- **testOpenGameWithNonExistentUser**: Попытка открыть игру с несуществующим пользователем
- **testOpenGameWithUserFromDifferentGame**: Попытка открыть игру пользователем из другой игры
- **testOpenGameWithoutGameId**: Открытие игры без указания ID игры
- **testOpenGameWithoutUserId**: Открытие игры без указания ID пользователя

#### 3. Работа со списком игр (тесты 3.x)

- **testGameListLoading**: Загрузка списка игр с подсчетом игроков
- **testEmptyGameList**: Обработка пустого списка игр

#### 4. Управление сессией (тесты 4.x)

- **testSessionStateAfterGameOpening**: Состояние сессии после открытия игры
- **testReopenGameWithDifferentUser**: Переоткрытие игры другим пользователем

#### 5. Граничные случаи (тесты 5.x)

- **testOpenGameWithMaxPlayers**: Открытие игры с максимальным количеством игроков

### Integration тесты (`tests/integration/OpenGameIntegrationTest.php`)

Интеграционные тесты проверяют полный процесс открытия игры:

#### 1. Основные интеграционные тесты

- **testFullGameOpeningProcess**: Полный процесс открытия игры
- **testGameOpeningSessionPersistence**: Сохранение данных в сессии
- **testGameOpeningWithDifferentConfigurations**: Открытие игр с разными конфигурациями

#### 2. Работа со списком игр

- **testGameListWithDifferentPlayerCounts**: Список игр с разным количеством игроков

#### 3. Обработка ошибок и безопасность

- **testErrorHandlingInGameOpening**: Обработка различных ошибок
- **testSecurityInvalidIds**: Безопасность при некорректных ID

#### 4. Производительность и масштабируемость

- **testPerformanceGameOpening**: Производительность открытия игры
- **testMultipleGameOpenings**: Множественное открытие игр

#### 5. Целостность данных

- **testGameOpeningDataIntegrity**: Целостность данных при открытии
- **testGameOpeningObjectRelationships**: Связи между объектами игры и пользователя

## Покрываемые сценарии

### Валидация входных данных

1. **ID игры**:
   - Существующий ID → успех
   - Несуществующий ID → ошибка "game error"
   - Отрицательный ID → ошибка
   - Нечисловой ID → ошибка

2. **ID пользователя**:
   - Существующий пользователь в игре → успех
   - Несуществующий пользователь → ошибка "user error"
   - Пользователь из другой игры → ошибка "user error"

### Работа с сессией

1. **Установка сессии**:
   - Корректная установка `game_id` и `user_id`
   - Сохранение существующих данных сессии
   - Перезапись при повторном открытии

2. **Состояние сессии**:
   - Проверка корректности установленных значений
   - Возможность получения объектов Game и User по ID из сессии

### Работа со списком игр

1. **Формирование списка**:
   - Корректный подсчет количества игроков в каждой игре
   - Сортировка по ID в descending порядке
   - Включение всех необходимых полей (name, map_w, map_h, ucount)

2. **Обработка пустого списка**:
   - Корректная обработка случая отсутствия игр

### Безопасность

1. **Валидация принадлежности**:
   - Проверка, что пользователь действительно принадлежит выбранной игре
   - Защита от попыток открыть чужую игру

2. **Обработка некорректных данных**:
   - Защита от SQL-инъекций через параметризацию запросов
   - Валидация типов данных (приведение к int)

### Производительность

1. **Время выполнения**:
   - Открытие игры должно выполняться менее чем за 1 секунду
   - Масштабируемость при максимальном количестве игроков

## Запуск тестов

### Запуск unit тестов
```bash
cd tests
php run_tests.php OpenGameTest
```

### Запуск integration тестов
```bash
cd tests
php run_tests.php OpenGameIntegrationTest
```

### Запуск всех тестов открытия игры
```bash
cd tests
php run_tests.php OpenGame
```

### Запуск всех тестов проекта
```bash
cd tests
php run_tests.php
```

## Отчеты

После выполнения тестов создаются следующие отчеты:

- **JUnit XML**: `tests/results/junit.xml`
- **TestDox HTML**: `tests/results/testdox.html`
- **Лог ошибок**: `tests/results/php_errors.log`

## Сравнение с другими функциями

### Отличия от тестов создания игры

1. **Предусловия**: Все тесты открытия начинаются с создания игры и пользователей
2. **Фокус на сессии**: Основное внимание уделяется установке и проверке сессионных данных
3. **Валидация связей**: Проверка принадлежности пользователя к игре
4. **Без создания данных**: Тесты не проверяют создание новых записей в БД

### Отличия от тестов редактирования игры

1. **Только чтение**: Функция открытия только читает данные, не изменяет их
2. **Сессионная логика**: Установка сессии вместо обновления данных игры
3. **Проверка связей**: Валидация принадлежности пользователя к игре
4. **Отсутствие валидации полей**: Нет проверки корректности названий, размеров карт и т.д.

## Заключение

Тестовое покрытие функции открытия игры обеспечивает:

- ✅ Полную проверку валидации входных данных
- ✅ Тестирование всех сценариев ошибок
- ✅ Проверку корректной работы с сессией
- ✅ Тестирование производительности
- ✅ Проверку безопасности и защиты от несанкционированного доступа
- ✅ Интеграционное тестирование с базой данных

Тесты гарантируют надежность и безопасность функции открытия игры, обеспечивая корректную аутентификацию пользователей и установку игрового контекста.
